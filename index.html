<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>수면 분석 챗봇</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    input, button { padding: 0.5rem; font-size: 1rem; margin: 0.25rem 0; }
    #result { margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; background: #f9f9f9; }
    #error { color: red; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>수면 분석 챗봇</h1>
  <div id="chat"></div>
  <div id="error"></div>
  <button id="nextBtn">다음</button>
  <div id="result"></div>

  <script>
    let step = 0;
    const answers = {};
    const chat = document.getElementById("chat");
    const result = document.getElementById("result");
    const errorDiv = document.getElementById("error");
    const nextBtn = document.getElementById("nextBtn");

    const questions = [
      "1. 몇 시에 잠자리에 들었습니까? (예: 23:00)",
      "2. 몇 시에 깨어났습니까? (예: 07:00)",
      "3. 자는 중 몇 번이나 깨어났습니까? (숫자만 입력)",
      "4. 평균적으로 잠들기까지 몇 분 걸리나요? (예: 30)"
    ];

    function nextStep() {
      const prevInput = document.querySelector("#chat input");
      const value = prevInput ? prevInput.value.trim() : "";
      errorDiv.textContent = "";

      if (prevInput && !value) {
        errorDiv.textContent = "⚠️ 값을 입력해주세요.";
        return;
      }

      if (step === 0 || step === 1) {
        if (!/^\d{1,2}:\d{2}$/.test(value)) {
          errorDiv.textContent = "⚠️ 시간을 hh:mm 형식으로 입력해주세요.";
          return;
        }
      } else if (step === 2 || step === 3) {
        if (isNaN(value) || Number(value) < 0) {
          errorDiv.textContent = "⚠️ 숫자로 입력해주세요.";
          return;
        }
      }

      if (prevInput) {
        answers[`q${step}`] = value;
        step++;
      }

      if (step < questions.length) {
        chat.innerHTML = `
          <label>${questions[step]}</label><br>
          <input type="text" id="inputStep${step}" autofocus />
        `;
      } else {
        chat.innerHTML = "";
        nextBtn.disabled = true;
        analyzeSleep();
      }
    }

    function analyzeSleep() {
      const sleepTime = parseTime(answers.q0);
      const wakeTime = parseTime(answers.q1);
      const wakeCount = parseInt(answers.q2);
      const sleepLatency = parseInt(answers.q3);

      const duration = (wakeTime + 24 - sleepTime) % 24;
      let summary = `총 수면 시간은 약 ${duration}시간입니다.`;
      const issues = [];
      const suggestions = [];
      const compliments = [];

      // 수면 시간 평가
      if (duration < 6) {
        issues.push("수면 시간이 부족합니다.");
        suggestions.push("최소 7~8시간의 수면을 취하는 것이 좋습니다.");
      } else if (duration >= 6 && duration <= 9) {
        compliments.push("적절한 수면 시간을 유지하고 계시네요.");
      } else if (duration > 9) {
        issues.push("수면 시간이 과도할 수 있습니다.");
        suggestions.push("지나치게 오래 자는 것도 피로의 원인이 될 수 있습니다.");
      }

      // 중간 각성 횟수 평가
      if (wakeCount === 0) {
        compliments.push("밤새 깊은 수면을 취하셨군요.");
      } else if (wakeCount === 1) {
        compliments.push("거의 방해받지 않는 수면을 하셨습니다.");
      } else if (wakeCount >= 2) {
        issues.push("수면 중 자주 깼습니다.");
        suggestions.push("카페인 섭취를 줄이거나, 저녁 늦은 운동은 피하세요.");
      }

      // 입면 시간 평가
      if (sleepLatency <= 15) {
        compliments.push("잠드는 데 큰 어려움이 없어 보입니다.");
      } else if (sleepLatency > 15 && sleepLatency <= 30) {
        compliments.push("입면 시간이 비교적 안정적입니다.");
      } else {
        issues.push("잠드는 데 시간이 오래 걸립니다.");
        suggestions.push("자기 전 스크린 사용을 줄이고, 조명을 어둡게 해보세요.");
      }

      result.innerHTML = `
        <strong>📝 요약:</strong> ${summary}<br>
        ${compliments.length > 0 ? `<strong>✅ 긍정적 요인:</strong><ul>${compliments.map(c => `<li>${c}</li>`).join("")}</ul>` : ""}
        ${issues.length > 0 ? `<strong>⚠️ 문제점:</strong><ul>${issues.map(i => `<li>${i}</li>`).join("")}</ul>` : ""}
        ${suggestions.length > 0 ? `<strong>💡 솔루션:</strong><ul>${suggestions.map(s => `<li>${s}</li>`).join("")}</ul>` : ""}
      `;
    }

    function parseTime(timeStr) {
      if (!timeStr || !timeStr.includes(":")) return 0;
      const [h, m] = timeStr.split(":").map(Number);
      return h + (m >= 30 ? 0.5 : 0);
    }

    // 초기 질문 표시
    chat.innerHTML = `
      <label>${questions[step]}</label><br>
      <input type="text" id="inputStep${step}" autofocus />
    `;
    nextBtn.addEventListener("click", nextStep);
  </script>
</body>
</html>
